<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloudinary Gallery with Supabase</title>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Your existing CSS styles here */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      text-align: center;
      padding: 30px 0;
      margin-bottom: 30px;
    }
    h1 {
      font-size: 2.5rem;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    /* ... include all your existing CSS ... */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üå§Ô∏è Cloudinary Gallery</h1>
      <p class="subtitle">Images stored in Supabase - Access from any device</p>
    </header>

    <div class="upload-section">
      <button id="upload_widget">Upload Image</button>
    </div>

    <div class="gallery-controls">
      <button class="filter-btn active" data-filter="all">All Images</button>
      <button class="filter-btn" data-filter="sample">Sample Images</button>
      <button class="filter-btn" data-filter="uploaded">My Uploads</button>
    </div>

    <div class="gallery" id="imageGallery">
      <div class="loading">Loading images...</div>
    </div>
  </div>

  <!-- Lightbox HTML (same as before) -->
  <div class="lightbox" id="lightbox">
    <span class="lightbox-close" id="lightboxClose">&times;</span>
    <img class="lightbox-img" id="lightboxImg" src="" alt="">
    <div class="lightbox-nav">
      <button class="lightbox-btn" id="prevBtn">&#10094;</button>
      <button class="lightbox-btn" id="nextBtn">&#10095;</button>
    </div>
  </div>

  <footer>
    <p>Cloudinary + Supabase Gallery &copy; 2023</p>
  </footer>

  <script>
    // Cloudinary configuration
    const cloudName = "dak7kqowo";
    const uploadPreset = "vd9hzqkh";

    // Supabase configuration
    const supabaseUrl = 'https://lickrfzfsildshrxgtre.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxpY2tyZnpmc2lsZHNocnhndHJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTgxOTMsImV4cCI6MjA3NjM3NDE5M30.dh1ks5kO0imqwyGcniHtUrR1sAM-vgpu6BIJFJXMBcQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // DOM elements
    const gallery = document.getElementById('imageGallery');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxClose = document.getElementById('lightboxClose');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const filterBtns = document.querySelectorAll('.filter-btn');

    // Sample images
    const sampleImages = [
      {
        src: "https://images.unsplash.com/photo-1501854140801-50d01698950b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1275&q=80",
        title: "Mountain Landscape",
        description: "Beautiful mountain scenery with trees and lake",
        category: "sample"
      },
      {
        src: "https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80",
        title: "Snowy Peaks",
        description: "Majestic snow-covered mountain peaks",
        category: "sample"
      }
    ];

    let uploadedImages = [];
    let allImages = [];
    let currentImageIndex = 0;
    let currentImageSet = allImages;

    // Initialize gallery
    async function initGallery() {
      await loadImagesFromSupabase();
      setupEventListeners();
      setupCloudinaryWidget();
      displayImages(allImages);
    }

    // Load images from Supabase
    async function loadImagesFromSupabase() {
      try {
        const { data, error } = await supabase
          .from('images')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        uploadedImages = data || [];
        allImages = [...sampleImages, ...uploadedImages];
        console.log('Loaded images from Supabase:', uploadedImages.length);
      } catch (error) {
        console.error('Error loading from Supabase:', error);
        uploadedImages = [];
        allImages = [...sampleImages];
      }
    }

    // Save image to Supabase
    async function saveImageToSupabase(imageData) {
      try {
        const { data, error } = await supabase
          .from('images')
          .insert([imageData])
          .select();

        if (error) throw error;
        console.log('Saved to Supabase:', data);
        return data[0];
      } catch (error) {
        console.error('Error saving to Supabase:', error);
        throw error;
      }
    }

    // Display images in gallery
    function displayImages(imagesToShow) {
      gallery.innerHTML = '';

      if (imagesToShow.length === 0) {
        gallery.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; padding: 40px; color: #7f8c8d;">No images found</p>';
        return;
      }

      imagesToShow.forEach((image, index) => {
        const galleryItem = document.createElement('div');
        galleryItem.className = `gallery-item ${image.category}`;
        galleryItem.innerHTML = `
          <img src="${image.src}" alt="${image.title}" class="gallery-img" loading="lazy">
          <div class="gallery-info">
            <h3 class="gallery-title">
              ${image.title}
              ${image.category === 'uploaded' ? '<span class="uploaded-badge">My Upload</span>' : ''}
            </h3>
            ${image.description ? `<p class="gallery-desc">${image.description}</p>` : ''}
            ${image.created_at ? `<p class="gallery-desc" style="font-size: 0.8rem; color: #95a5a6;">Uploaded: ${new Date(image.created_at).toLocaleDateString()}</p>` : ''}
          </div>
        `;
        galleryItem.addEventListener('click', () => openLightbox(index, imagesToShow));
        gallery.appendChild(galleryItem);
      });
    }

    // Setup Cloudinary widget
    function setupCloudinaryWidget() {
      const myWidget = cloudinary.createUploadWidget({
        cloudName: cloudName,
        uploadPreset: uploadPreset
      }, async (error, result) => {
        if (!error && result && result.event === "success") {
          console.log("Uploaded to Cloudinary:", result.info.secure_url);

          const imageData = {
            src: result.info.secure_url,
            title: result.info.original_filename || "My Uploaded Image",
            description: "Uploaded via Cloudinary",
            category: "uploaded",
            public_id: result.info.public_id,
            created_at: new Date().toISOString()
          };

          try {
            // Save to Supabase
            const savedImage = await saveImageToSupabase(imageData);
            
            // Update local arrays
            uploadedImages.unshift(savedImage);
            allImages.unshift(savedImage);

            // Update display
            displayImages(allImages);

            // Switch to uploaded filter
            filterBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('[data-filter="uploaded"]').classList.add('active');
            displayImages(uploadedImages);

            console.log('Image saved to Supabase and displayed');
          } catch (error) {
            console.error('Failed to save to Supabase:', error);
            alert('Image uploaded but failed to save to database.');
          }
        }
      });

      document.getElementById("upload_widget").addEventListener("click", () => {
        myWidget.open();
      });
    }

    // Event listeners and other functions (same as before)
    function setupEventListeners() {
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const filter = btn.getAttribute('data-filter');
          let imagesToShow;
          
          if (filter === 'all') imagesToShow = allImages;
          else if (filter === 'uploaded') imagesToShow = uploadedImages;
          else imagesToShow = allImages.filter(img => img.category === filter);
          
          displayImages(imagesToShow);
        });
      });

      // Lightbox event listeners (same as before)
      lightboxClose.addEventListener('click', closeLightbox);
      prevBtn.addEventListener('click', showPrevImage);
      nextBtn.addEventListener('click', showNextImage);
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) closeLightbox();
      });
      document.addEventListener('keydown', (e) => {
        if (lightbox.classList.contains('active')) {
          if (e.key === 'Escape') closeLightbox();
          if (e.key === 'ArrowLeft') showPrevImage();
          if (e.key === 'ArrowRight') showNextImage();
        }
      });
    }

    // Lightbox functions (same as before)
    function openLightbox(index, imageSet) {
      currentImageIndex = index;
      currentImageSet = imageSet;
      lightboxImg.src = currentImageSet[currentImageIndex].src;
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      lightbox.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    function showPrevImage() {
      currentImageIndex = (currentImageIndex - 1 + currentImageSet.length) % currentImageSet.length;
      lightboxImg.src = currentImageSet[currentImageIndex].src;
    }

    function showNextImage() {
      currentImageIndex = (currentImageIndex + 1) % currentImageSet.length;
      lightboxImg.src = currentImageSet[currentImageIndex].src;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', initGallery);
  </script>
</body>
</html>

