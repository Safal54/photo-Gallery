<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Photo Gallery</title>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Poppins:wght@300;400;500&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f9f0ff 0%, #fce4ec 50%, #f3e5f5 100%);
      color: #5d4037;
      line-height: 1.6;
      padding: 15px;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 10px;
    }

    header {
      text-align: center;
      padding: 25px 0;
      margin-bottom: 20px;
    }

    h1 {
      font-family: 'Dancing Script', cursive;
      font-size: 3rem;
      color: #8e24aa;
      margin-bottom: 10px;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .subtitle {
      font-size: 1.1rem;
      color: #7b1fa2;
      max-width: 300px;
      margin: 0 auto;
      font-weight: 300;
    }

    .upload-section {
      text-align: center;
      margin-bottom: 30px;
    }

    #upload_widget {
      padding: 16px 32px;
      background: linear-gradient(45deg, #e91e63, #9c27b0);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
    }

    #upload_widget:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(156, 39, 176, 0.4);
    }

    .gallery {
      column-count: 2;
      column-gap: 12px;
      margin-bottom: 20px;
    }

    .gallery-item {
      break-inside: avoid;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .gallery-item:active {
      transform: scale(0.98);
    }

    .gallery-media {
      width: 100%;
      height: auto;
      display: block;
    }

    .video-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      z-index: 2;
    }

    .media-container {
      position: relative;
    }

    .lightbox {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      touch-action: pan-y pinch-zoom;
    }

    .lightbox.active {
      display: flex;
      opacity: 1;
    }

    .lightbox-media {
      max-width: 95%;
      max-height: 80%;
      object-fit: contain;
      border-radius: 8px;
      user-select: none;
      -webkit-user-select: none;
    }

    .lightbox-video {
      max-width: 95%;
      max-height: 80%;
      border-radius: 8px;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 2.5rem;
      cursor: pointer;
      z-index: 1001;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Poppins', sans-serif;
    }

    .lightbox-nav {
      position: absolute;
      bottom: 30px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .lightbox-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      transition: background 0.3s ease;
      backdrop-filter: blur(10px);
      font-family: 'Poppins', sans-serif;
    }

    .lightbox-btn:active {
      background: rgba(255, 255, 255, 0.4);
    }

    .image-counter {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      font-size: 1rem;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 16px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      font-family: 'Poppins', sans-serif;
    }

    .swipe-hint {
      position: absolute;
      bottom: 100px;
      width: 100%;
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
      animation: pulse 2s infinite;
      font-family: 'Poppins', sans-serif;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.7;
      }

      50% {
        opacity: 0.3;
      }
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #7b1fa2;
      font-size: 1.1rem;
      grid-column: 1 / -1;
    }

    /* Heart animation */
    .heart {
      position: fixed;
      font-size: 20px;
      pointer-events: none;
      animation: float 6s ease-in-out infinite;
      opacity: 0.7;
      z-index: -1;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0) rotate(0deg);
      }

      50% {
        transform: translateY(-20px) rotate(180deg);
      }
    }

    /* Mobile-first responsive design */
    @media (min-width: 768px) {
      .gallery {
        column-count: 3;
        column-gap: 15px;
      }

      .container {
        max-width: 800px;
        padding: 20px;
      }
    }

    @media (max-width: 480px) {
      .gallery {
        column-count: 2;
      }

      h1 {
        font-size: 2.5rem;
      }

      .subtitle {
        font-size: 1rem;
      }

      .lightbox-media,
      .lightbox-video {
        max-height: 70%;
      }

      .lightbox-nav {
        bottom: 20px;
      }
    }

    @media (max-width: 360px) {
      .gallery {
        column-count: 1;
      }

      h1 {
        font-size: 2.2rem;
      }
    }

    /* Hide scrollbars but keep functionality */
    .lightbox::-webkit-scrollbar {
      display: none;
    }

    .lightbox {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Same look as Add Memory button */
    #massages_button {
      padding: 16px 32px;
      background: linear-gradient(45deg, #e91e63, #9c27b0);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      margin-left: 10px;
      /* spacing between buttons */
    }

    #massages_button:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(156, 39, 176, 0.4);
    }

    /* Make buttons responsive on small screens */
    @media (max-width: 600px) {
      .upload-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      #upload_widget,
      #massages_button {
        width: 90%;
        max-width: 300px;
        margin: 0;
        font-size: 1rem;
        padding: 14px 0;
      }
    }
  </style>
</head>

<body>
  <!-- Floating hearts for romantic effect -->
  <div class="heart" style="left: 10%; animation-delay: 0s;">‚ù§Ô∏è</div>
  <div class="heart" style="left: 20%; animation-delay: 1s;">üíñ</div>
  <div class="heart" style="left: 30%; animation-delay: 2s;">üíï</div>
  <div class="heart" style="left: 40%; animation-delay: 3s;">üíó</div>
  <div class="heart" style="left: 50%; animation-delay: 4s;">üíì</div>

  <div class="container">
    <header>
      <h1>My Memories</h1>
      <p class="subtitle">Photos & Videos ‚ù§Ô∏èüíï</p>
    </header>

    <div class="upload-section">
      <button id="upload_widget">üíù Add Memory</button>
      <button id="massages_button" onclick="window.location.href='massages.html'">üí¨ Massages</button>
    </div>

    <div class="gallery" id="imageGallery">
      <div class="loading">Loading your memories...</div>
    </div>
  </div>

  <div class="lightbox" id="lightbox">
    <span class="lightbox-close" id="lightboxClose">√ó</span>
    <div class="image-counter" id="imageCounter">1 / 1</div>
    <div id="lightboxContent"></div>
    <div class="swipe-hint">Swipe left/right or scroll to navigate</div>
    <div class="lightbox-nav">
      <button class="lightbox-btn" id="prevBtn">‚ùÆ</button>
      <button class="lightbox-btn" id="nextBtn">‚ùØ</button>
    </div>
  </div>
  <footer>
    <p style="text-align: center; padding: 15px; color: #7b1fa2; font-size: 0.9rem;">
      &copy; 2024 My Memories. All rights reserved.
    </p>
  </footer>
  <script>
    // Cloudinary configuration
    const cloudName = "dak7kqowo";
    const uploadPreset = "vd9hzqkh";

    // Supabase configuration
    const supabaseUrl = 'https://lickrfzfsildshrxgtre.supabase.co';
    const supabaseKey = 'sb_publishable_6HzxgzpQpm1R4RGB6oHwnA_CkPux1-D';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // DOM elements
    const gallery = document.getElementById('imageGallery');
    const lightbox = document.getElementById('lightbox');
    const lightboxContent = document.getElementById('lightboxContent');
    const lightboxClose = document.getElementById('lightboxClose');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const imageCounter = document.getElementById('imageCounter');

    let uploadedImages = [];
    let allImages = [];
    let currentImageIndex = 0;
    let currentImageSet = allImages;
    let touchStartX = 0;
    let touchStartY = 0;

    // Check if file is video
    function isVideo(url) {
      return url.match(/\.(mp4|webm|ogg|mov|avi|wmv|flv|mkv)$/i) ||
        url.includes('/video/') ||
        url.includes('resource_type=video');
    }

    // Initialize gallery
    async function initGallery() {
      await loadImagesFromSupabase();
      setupEventListeners();
      setupCloudinaryWidget();
      displayImages(allImages);
    }

    // Load images from Supabase (newest first)
    async function loadImagesFromSupabase() {
      try {
        const { data, error } = await supabase
          .from('images')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        uploadedImages = data || [];
        allImages = uploadedImages; // Only show user's images
        console.log('Loaded memories from Supabase:', uploadedImages.length);
      } catch (error) {
        console.error('Error loading from Supabase:', error);
        uploadedImages = [];
        allImages = [];
      }
    }

    // Save image to Supabase
    async function saveImageToSupabase(imageData) {
      try {
        const { data, error } = await supabase
          .from('images')
          .insert([imageData])
          .select();

        if (error) throw error;
        console.log('Saved to Supabase:', data);
        return data[0];
      } catch (error) {
        console.error('Error saving to Supabase:', error);
        throw error;
      }
    }

    // Display images in gallery (newest first)
    function displayImages(imagesToShow) {
      gallery.innerHTML = '';

      if (imagesToShow.length === 0) {
        gallery.innerHTML = '<p style="text-align: center; padding: 40px; color: #7b1fa2;">No memories yet. Tap "Add Memory" to start! üíù</p>';
        return;
      }

      imagesToShow.forEach((image, index) => {
        const galleryItem = document.createElement('div');
        galleryItem.className = 'gallery-item';

        const isVideoFile = isVideo(image.src);

        galleryItem.innerHTML = `
          <div class="media-container">
            ${isVideoFile ?
            `<video class="gallery-media" playsinline muted loop>
                 <source src="${image.src}" type="video/mp4">
                 Your browser does not support the video tag.
               </video>
               <div class="video-icon">VIDEO</div>` :
            `<img src="${image.src}" alt="Memory" class="gallery-media" loading="lazy">`
          }
          </div>
        `;

        // Auto-play videos in gallery
        if (isVideoFile) {
          setTimeout(() => {
            const video = galleryItem.querySelector('video');
            if (video) {
              video.play().catch(e => console.log('Video autoplay prevented:', e));
            }
          }, 100);
        }

        galleryItem.addEventListener('click', () => openLightbox(index, imagesToShow));
        gallery.appendChild(galleryItem);
      });
    }

    // Setup Cloudinary widget
    function setupCloudinaryWidget() {
      const myWidget = cloudinary.createUploadWidget({
        cloudName: cloudName,
        uploadPreset: uploadPreset,
        sources: ['local', 'camera'],
        multiple: false,
        clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'mp4', 'mov', 'avi'],
        maxFileSize: 20000000, // 20MB for videos
        cropping: false,
        showAdvancedOptions: false,
        styles: {
          palette: {
            window: "#FFFFFF",
            sourceBg: "#F5F5F5",
            windowBorder: "#9c27b0",
            tabIcon: "#8e24aa",
            inactiveTabIcon: "#BA68C8",
            menuIcons: "#8e24aa",
            link: "#e91e63",
            action: "#e91e63",
            inProgress: "#e91e63",
            complete: "#4CAF50",
            error: "#F44336",
            textDark: "#4A148C",
            textLight: "#FFFFFF"
          }
        }
      }, async (error, result) => {
        if (!error && result && result.event === "success") {
          console.log("Uploaded to Cloudinary:", result.info.secure_url);
          console.log("Resource type:", result.info.resource_type);

          const imageData = {
            src: result.info.secure_url,
            resource_type: result.info.resource_type,
            public_id: result.info.public_id,
            created_at: new Date().toISOString()
          };

          try {
            // Save to Supabase
            const savedImage = await saveImageToSupabase(imageData);

            // Add to beginning of arrays (newest first)
            uploadedImages.unshift(savedImage);
            allImages.unshift(savedImage);

            // Update display
            displayImages(allImages);

            console.log('Memory saved and displayed');
          } catch (error) {
            console.error('Failed to save to Supabase:', error);
            alert('Memory uploaded but failed to save. Please try again.');
          }
        }

        if (error) {
          console.error('Upload error:', error);
          alert('Error uploading memory. Please try again.');
        }
      });

      document.getElementById("upload_widget").addEventListener("click", () => {
        myWidget.open();
      });
    }

    // Touch and scroll event handlers
    function setupEventListeners() {
      // Lightbox event listeners
      lightboxClose.addEventListener('click', closeLightbox);
      prevBtn.addEventListener('click', showPrevImage);
      nextBtn.addEventListener('click', showNextImage);

      // Touch events for mobile swipe
      lightbox.addEventListener('touchstart', handleTouchStart, { passive: true });
      lightbox.addEventListener('touchmove', handleTouchMove, { passive: false });

      // Wheel events for desktop scroll
      lightbox.addEventListener('wheel', handleWheel, { passive: false });

      // Close lightbox when clicking outside the media
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          closeLightbox();
        }
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (lightbox.classList.contains('active')) {
          if (e.key === 'Escape') closeLightbox();
          if (e.key === 'ArrowLeft') showPrevImage();
          if (e.key === 'ArrowRight') showNextImage();
        }
      });
    }

    // Touch start handler
    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }

    // Touch move handler for swipe gestures
    function handleTouchMove(e) {
      if (!touchStartX || !touchStartY) return;

      const touchEndX = e.touches[0].clientX;
      const touchEndY = e.touches[0].clientY;

      const diffX = touchStartX - touchEndX;
      const diffY = touchStartY - touchEndY;

      // Only prevent default if we're doing a horizontal swipe (media navigation)
      if (Math.abs(diffX) > Math.abs(diffY)) {
        e.preventDefault();

        if (diffX > 50) {
          // Swipe left - next media
          showNextImage();
          touchStartX = null;
          touchStartY = null;
        } else if (diffX < -50) {
          // Swipe right - previous media
          showPrevImage();
          touchStartX = null;
          touchStartY = null;
        }
      } else if (Math.abs(diffY) > 100) {
        // Vertical scroll - close lightbox
        closeLightbox();
        touchStartX = null;
        touchStartY = null;
      }
    }

    // Wheel handler for scroll gestures
    function handleWheel(e) {
      e.preventDefault();

      if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
        // Horizontal scroll - change media
        if (e.deltaX > 0) {
          showNextImage();
        } else {
          showPrevImage();
        }
      } else {
        // Vertical scroll - close lightbox
        if (Math.abs(e.deltaY) > 50) {
          closeLightbox();
        }
      }
    }

    // Open lightbox with selected media
    function openLightbox(index, mediaSet) {
      currentImageIndex = index;
      currentImageSet = mediaSet;

      const currentMedia = currentImageSet[currentImageIndex];
      const isVideoFile = isVideo(currentMedia.src);

      // Clear previous content
      lightboxContent.innerHTML = '';

      if (isVideoFile) {
        // Create video element for lightbox
        const video = document.createElement('video');
        video.className = 'lightbox-video';
        video.src = currentMedia.src;
        video.controls = true;
        video.autoplay = true;
        video.muted = true;
        video.playsInline = true;

        lightboxContent.appendChild(video);

        // Try to play video
        video.play().catch(e => {
          console.log('Video play prevented, trying with user gesture:', e);
          // If autoplay is blocked, wait for user interaction
          lightbox.addEventListener('click', function playVideoOnce() {
            video.play().catch(e => console.log('Still cannot play video:', e));
            lightbox.removeEventListener('click', playVideoOnce);
          }, { once: true });
        });
      } else {
        // Create image element for lightbox
        const img = document.createElement('img');
        img.className = 'lightbox-media';
        img.src = currentMedia.src;
        img.alt = 'Memory';

        lightboxContent.appendChild(img);
      }

      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
      updateImageCounter();
    }

    // Close lightbox
    function closeLightbox() {
      // Pause any playing videos
      const video = lightboxContent.querySelector('video');
      if (video) {
        video.pause();
      }

      lightbox.classList.remove('active');
      document.body.style.overflow = 'auto';
      touchStartX = 0;
      touchStartY = 0;
    }

    // Show previous media
    function showPrevImage() {
      currentImageIndex = (currentImageIndex - 1 + currentImageSet.length) % currentImageSet.length;
      openLightbox(currentImageIndex, currentImageSet);
    }

    // Show next media
    function showNextImage() {
      currentImageIndex = (currentImageIndex + 1) % currentImageSet.length;
      openLightbox(currentImageIndex, currentImageSet);
    }

    // Update image counter
    function updateImageCounter() {
      imageCounter.textContent = `${currentImageIndex + 1} / ${currentImageSet.length}`;
    }

    // Initialize the gallery when the page loads
    document.addEventListener('DOMContentLoaded', initGallery);
  </script>
</body>

</html>
